<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- mapper >> interface 매핑 : id 값 중요 (interface 메소드) -->
<mapper namespace="com.actas.ems.Mapper.Elvlrt.App14ElvlrtMapper">

    <!--  보수기사목록  -->
    <select id="GetApp14List001"  parameterType="com.actas.ems.DTO.Popup.PopupDto" resultType="com.actas.ems.DTO.Elvlrt.App14ElvlrtDto">
        <![CDATA[
        SELECT  Z.perid 		 ,
		    Z.pernm 		 ,
			Z.divicd		,
		    Z.divinm	 	,
			Z.rspnm 		 ,
			Z.tel			,
			Z.handphone,
		    Z.entdate		 ,
			Z.DAYTERM	,
			Z.AGEGAP	,
			Z.blood		,
			Z.mrgyn		,
			Z.fami60		,
			Z.schnm		,
			Z.igrad		,
			Z.carm		,
			Z.grad		,
			Z.army		,
			Z.disperyn	,
			Z.email		,
			isnull( Z.zipadres, '') as zipadres	,
			isnull( Z.adres, '' ) as adres		,
			Z.rtclafi		,
			Z.perclasifi,
			Z.rnum,
			Z.majo,
			Z.rspcd,
			cast(0 as Decimal(7,1) ) as jopyear
FROM
(
						SELECT  A.perid,
						 A.pernm 	 ,
						 C.divinm	 ,
						D.rspnm  ,
						A.tel		,
						A.handphone,
						 A.entdate ,
						DATEDIFF(year, A.ENTDATE, GETDATE()) AS DAYTERM,
						case len(SUBSTRING(A.RNUM,1,6))  when 6  then DATEDIFF(YEAR,   SUBSTRING(A.RNUM,1,6), GETDATE()) + 1
						else 	0 end AS AGEGAP,
						(select blood from tb_pa102 where custcd=A.custcd and spjangcd=A.spjangcd and perid=A.perid ) as blood,
						A.mrgyn	,
						A.fami60,
						(select top 1  schnm from tb_pa101 where custcd=A.custcd and spjangcd=A.spjangcd and perid=A.perid order by schcd desc ) as schnm,
						(select top 1  igrad   from tb_pa101 where custcd=A.custcd and spjangcd=A.spjangcd and perid=A.perid order by schcd desc )   as igrad,
						(select top 1  majo   from tb_pa101 where custcd=A.custcd and spjangcd=A.spjangcd and perid=A.perid order by schcd desc )   as majo,
						(select carm from tb_pa102 where custcd=A.custcd and spjangcd=A.spjangcd and perid=A.perid ) as carm,
						(select grad from tb_pa102 where custcd=A.custcd and spjangcd=A.spjangcd and perid=A.perid ) as grad,
						(select army from tb_pa102 where custcd=A.custcd and spjangcd=A.spjangcd and perid=A.perid ) as army,
						A.disperyn,
						A.email,
						A.zipadres,
						A.adres,
						C.divicd,
						A.mpclafi,
						A.rtclafi,
						A.perclasifi,
						A.rspcd,
						left(A.rnum,6) + '*******' as rnum
			  FROM TB_JA001 A,
					 TB_XA012 B,
					 TB_JC002 C,
					 TB_PZ001 D
			 WHERE (A.custcd   = B.custcd   )
				AND (A.spjangcd = B.spjangcd )
				AND (A.custcd   = C.custcd   )
				AND (A.spjangcd   = C.spjangcd   )
				AND (A.divicd   = C.divicd   )
				AND (A.custcd   = D.custcd   )
				AND (A.spjangcd = D.spjangcd )
				AND (A.rspcd    = D.rspcd    )
				AND (C.divicd = #{divicd} OR #{divicd} = '%')
				AND (A.perid = #{perid} OR #{perid} = '%')
				AND (A.rtclafi = #{rtclafi} OR #{rtclafi} = '%')

) Z

        ]]>
    </select>

</mapper>
