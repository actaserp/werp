<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- mapper >> interface 매핑 : id 값 중요 (interface 메소드) -->
<mapper namespace="com.actas.ems.Mapper.master.AuthDBMapper">
    <insert id="TBXUSERS_Insert" parameterType="com.actas.ems.DTO.UserFormDto" keyProperty="username">
        INSERT INTO TB_XUSERS(userid, rnum, passwd1, passwd2, custnm, pernm, useyn, password, role, custcd, spjangcd,
                              username, actcd, actnm, saupnum, flag, phone, dbnm, encodepw, wrongnum)
        VALUES (#{userid},#{rnum}, #{passwd1}, #{passwd2}, #{custnm}, #{pernm}, #{useyn}, #{password}, #{role}, #{custcd}, #{spjangcd},
                #{username}, #{actcd}, #{actnm}, #{saupnum}, #{flag}, #{phone}, #{dbnm}, #{encodepw}, 0)
    </insert>
    <select id="GetUserInfo" parameterType="com.actas.ems.DTO.UserFormDto"  resultType="com.actas.ems.DTO.UserFormDto">
        select top 1 userid, passwd1,  username, actcd, actnm, saupnum, flag, phone, pernm, useyn, role, dbnm, wrongnum
         from TB_XUSERS where userid=#{userid} and passwd1=#{passwd1}
    </select>
    <select id="GetUserInfoDto" parameterType="com.actas.ems.DTO.UserFormDto"  resultType="com.actas.ems.DTO.UserFormDto">
        select top 1 userid, passwd1,  username, actcd, actnm, saupnum, flag, phone, pernm, useyn, role, dbnm, wrongnum
        from TB_XUSERS where userid=#{userid}
    </select>
    <select id="GetClientInfo" parameterType="com.actas.ems.DTO.UserFormDto" resultType="String">
        SELECT dbo.uf_client_info(#{saupnum})
    </select>
    <select id="GetClientInfoName" parameterType="com.actas.ems.DTO.UserFormDto" resultType="String">
        SELECT dbo.uf_clientnm_info(#{actcd})
    </select>
    <update id="UpdateDbInfo" parameterType="com.actas.ems.DTO.UserFormDto"  >
        UPDATE TB_XUSERS SET  dbnm=#{dbnm}, cltcd=#{cltcd}
        from TB_XUSERS  where userid=#{userid} and passwd1=#{passwd1}
    </update>

    <select id="TB_XUSER_DUPCHK" parameterType="com.actas.ems.DTO.UserFormDto" resultType="String">
        SELECT TOP 1 A.userid as userid
        FROM tb_xusers A WITH(NOLOCK)
        WHERE A.userid=#{userid}
    </select>

    <select id="TB_XCLIENT_SELECT" parameterType="com.actas.ems.DTO.UserFormDto" resultType="String">
        <!--SELECT DBO.UF_CLIENT_INFO(#{saupnum}) -->
        <!--
        SELECT TOP 1 A.cltnm as cltnmsa
        FROM tb_xusers A WITH(NOLOCK)
        WHERE A.saupnum=#{saupnum}
        -->

        SELECT dbo.uf_clientnm_info(#{saupnum}) as cltcd

        <!--SELECT dbo.uf_clientnm_info(#{saupnum}) as cltnm -->

    </select>


    <select id="TB_XUSER_PHDUPCHK" parameterType="com.actas.ems.DTO.UserFormDto" resultType="String">
        SELECT TOP 1 A.phone as phone
        FROM TB_XUSERS A WITH(NOLOCK)
        WHERE A.phone=#{phone}
    </select>

    <insert id="TB_XLOGIN_INSERT" parameterType="com.actas.ems.DTO.UserFormDto">
        INSERT INTO TB_XLOGIN
        (userid, ipaddr, onoffdt, custnm, usernm, ondate, onoffdv)
        VALUES
        (#{userid}, #{ipaddr}, convert(varchar(8),getDate(),112), #{cltnm}, #{username}, getDate(), 'Y')
    </insert>

    <update id="TB_XUSERS_LOGFAIL" parameterType="com.actas.ems.DTO.UserFormDto">
        UPDATE TB_XUSERS SET
        wrongnum = wrongnum + 1
        WHERE userid = #{userid}
    </update>

    <update id="TB_XUSERS_LOGSUCC" parameterType="com.actas.ems.DTO.UserFormDto">
        UPDATE TB_XUSERS SET
        wrongnum = 0
        WHERE userid = #{userid}
    </update>

    <select id="TB_XUSER_DBNM" parameterType="com.actas.ems.DTO.UserFormDto" resultType="String">
        select top(1) dbnm from tb_xusers where saupnum=#{saupnum}
    </select>

    <update id="TB_XUSER_UPDATE" parameterType="com.actas.ems.DTO.UserFormDto">
        UPDATE TB_XUSERS SET
            username = #{username}, passwd1 = #{passwd1}, passwd2 = #{passwd2}, phone = #{phone}
        WHERE userid = #{userid}
    </update>
</mapper>
